#!/usr/bin/env php
<?php

/**
 * Production-Ready storage:link command
 *
 * Creates a symbolic link from:
 *   public/storage  →  storage/app/public
 *
 * Supports:
 * - Windows (fallback to directory junction)
 * - Linux/macOS
 * - Safe checks for existing link, broken link, or real folder
 */

if (php_sapi_name() !== 'cli') {
    fwrite(STDERR, "This script can only be run from CLI.\n");
    exit(1);
}

$argv = $_SERVER['argv'] ?? [];

// Ensure command exists
if (!isset($argv[1])) {
    echo "Usage: php caremi storage:link\n";
    exit(1);
}

$command = $argv[1];

// Only process storage:link
if ($command !== 'storage:link') {
    echo "Unknown command: {$command}\n";
    exit(1);
}

/**
 * Resolve absolute project paths
 */
$root = realpath(__DIR__);
$publicPath = $root . DIRECTORY_SEPARATOR . 'public';
$storagePath = $root . DIRECTORY_SEPARATOR . 'storage/app/public';
$linkPath = $publicPath . DIRECTORY_SEPARATOR . 'storage';

/**
 * Verify storage/app/public exists
 */
if (!is_dir($storagePath)) {
    fwrite(STDERR, "[ERROR] storage/app/public directory does not exist.\n");
    exit(1);
}

/**
 * If link already exists — check type
 */
if (file_exists($linkPath) || is_link($linkPath)) {

    // Is it a valid symlink?
    if (is_link($linkPath)) {
        $target = readlink($linkPath);
        if ($target && realpath($storagePath) === realpath($target)) {
            echo "\033[32m[OK]\033[0m Storage link already exists.\n";
            exit(0);
        } else {
            // Broken or incorrect symlink → remove safely
            unlink($linkPath);
            echo "\033[33m[WARNING]\033[0m Existing incorrect symlink removed.\n";
        }
    } else {
        // It's a real folder, not a symlink
        fwrite(STDERR, "\033[31m[ERROR]\033[0m 'public/storage' exists and is NOT a symlink.\n");
        fwrite(STDERR, "Please remove or rename it manually.\n");
        exit(1);
    }
}

/**
 * Create symbolic link
 */
try {
    if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
        // Windows (directory junction)
        $cmd = sprintf('mklink /J "%s" "%s"', $linkPath, $storagePath);
        exec($cmd, $output, $result);

        if ($result !== 0) {
            throw new Exception("Failed to create symlink. Run CMD as Administrator.");
        }

    } else {
        // Linux / macOS
        if (!symlink($storagePath, $linkPath)) {
            throw new Exception("symlink() failed to create the link.");
        }
    }

    echo "\033[32m[SUCCESS]\033[0m Storage linked successfully.\n";
    echo "public/storage → storage/app/public\n";
    exit(0);

} catch (Exception $e) {
    fwrite(STDERR, "\033[31m[ERROR]\033[0m {$e->getMessage()}\n");
    exit(1);
}
